<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--      
	This file is automatically generated by autoCode(https://git.oschina.net/durcframework/autoCode)
-->
<mapper namespace="com.info.back.dao.IMmanLoanCollectionRecordDao">
	<resultMap id="queryResultMap" type="com.info.web.pojo.cspojo.MmanLoanCollectionRecord">
		<!-- id -->
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<!-- 催收订单ID（借款编号） -->
		<result column="order_id" property="orderId" jdbcType="VARCHAR"/>
		<!-- 催收员ID -->
		<result column="collection_id" property="collectionId" jdbcType="VARCHAR"/>
		<!-- 借款人ID -->
		<result column="user_id" property="userId" jdbcType="VARCHAR"/>
		<!-- 联系人类型 1: 紧急联系人 2:通讯录联系人 -->
		<result column="contact_type" property="contactType" jdbcType="VARCHAR"/>
		<!-- 联系人姓名 -->
		<result column="contact_name" property="contactName" jdbcType="VARCHAR"/>
		<!-- 联系人关系 -->
		<result column="relation" property="relation" jdbcType="VARCHAR"/>
		<!-- 联系人电话 -->
		<result column="contact_phone" property="contactPhone" jdbcType="VARCHAR"/>
		<!-- 施压等级(施压等级一、二、三 字典) -->
		<result column="stress_level" property="stressLevel" jdbcType="VARCHAR"/>
		<!-- 当前催收状态 0待催收、1催收中、2承诺还款、3委外中、4委外成功、5催收成功 字典 -->
		<result column="order_state" property="orderState" jdbcType="VARCHAR"/>
		<!-- 催收类型( 1电话催收、2短信催收（可点击发短信）字典) -->
		<result column="collection_type" property="collectionType" jdbcType="VARCHAR"/>
		<!-- 催收时间 -->
		<result column="collection_date" property="collectionDate" jdbcType="TIMESTAMP"/>
		<!-- 催收到的金额 -->
		<result column="collectionAmount" property="collectionAmount" jdbcType="DECIMAL"/>
		<!-- 催收内容 -->
		<result column="content" property="content" jdbcType="VARCHAR"/>
		<!-- 创建时间 -->
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP"/>
		<!-- 更新时间 -->
		<result column="update_date" property="updateDate" jdbcType="TIMESTAMP"></result>
		<!-- 备注（以备催收人员查阅） -->
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
		<!--催收员姓名-->
		<result column="collectionPerson" property="collectionPerson" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 保存,保存不为NULL的字段 -->
	
	<select id="findAll" resultMap="queryResultMap" parameterType="HashMap">
		select
			 re.id,mo.loan_id as orderId,lo.realname as user_id,bu.group_level as collectionGroup,re.contact_type,re.contact_name,re.relation,re.contact_phone,
			 re.stress_level,re.order_state,re.collection_type,re.collection_date,re.collectionAmount,re.content,
			 re.create_date,re.update_date,re.remark,mo.current_overdue_level,bu.user_name as collectionPerson
		from 
		<include refid="base_table"></include>
		<include refid="base_where"></include>
		order by re.update_date DESC
	</select>
	
	<select id="findAllCount" parameterType="HashMap" resultType="Integer">
		select count(1) 
		from
		<include refid="base_table"></include>
		<include refid="base_where"></include>
	</select>
	
	<sql id="base_where">
		<where>
			<!-- 借款订单 -->
			<if test="orderId != null and orderId != ''"  >
				AND mo.loan_id = #{orderId}
			</if>
			<!-- 催收员 -->
			<if test="collectionName != null and collectionName != ''">
				AND bu.user_name = #{collectionName}
			</if>
			<!-- 催收时间 -->
			<if test="collectionDateBegin != null and collectionDateBegin != ''">
				AND DATE_FORMAT(re.collection_date,'%Y-%m-%d') &gt;= #{collectionDateBegin}
			</if>
			<if test="collectionDateEnd != null and collectionDateEnd != ''">
				AND DATE_FORMAT(re.collection_date,'%Y-%m-%d') &lt;= #{collectionDateEnd}
			</if>
			<if test="collectionDateBegin != null and collectionDateBegin != '' and collectionDateEnd != null and collectionDateEnd != ''">
				AND DATE_FORMAT(re.collection_date,'%Y-%m-%d') &gt;= #{collectionDateBegin} AND DATE_FORMAT(re.collection_date,'%Y-%m-%d') &lt;= #{collectionDateEnd}
			</if>
			<!-- 催收类型 -->
			<if test="collectionType != null and collectionType != ''">
				AND re.collection_type = #{collectionType}
			</if>
			<!-- 施压等级 -->
			<!-- <if test="stressLevel != null and stressLevel != ''">
				AND re.stress_level = #{stressLevel}
 			</if> -->
 			<!-- 催收状态 -->
 			<if test="collectionStatus != null and collectionStatus != ''">
	 			AND re.order_state = #{collectionStatus}	
 			</if>
 			<!-- 催收组(逾期等级) -->
 			<if test="overdueLevel != null and overdueLevel != ''">
 				AND mo.current_overdue_level = #{overdueLevel}
 			</if>
 			<!-- 催收员只能查看自己的记录 -->
			<if test="userRoleId != null and userRoleId != ''">
				AND re.collection_id = #{userRoleId}
			</if>
			<!-- 委外经理能查看自己公司的记录 -->
			<!-- <if test="outSourceCompanyId != null and outSourceCompanyId != ''">
				AND bp.company_id = outSourceCompanyId
			</if> -->
			
			<if test="CompanyPermissionsList != null and CompanyPermissionsList.size>0 " >
				AND bu.`company_id` in  
					<foreach collection="CompanyPermissionsList" close=")" item="items" open="(" separator=",">
						#{items.companyId} 
					</foreach>
			</if>
			
			<!-- 催收主管或者是经理可以查看全部记录 -->
			<!-- <if test="noAdmin != null and noAdmin != ''">
				AND 1 = 1
			</if> -->
		</where>
	</sql>
	<sql id="base_table">
			mman_loan_collection_record re
			left join back_user bu on re.collection_id= bu.uuid
			left join mman_user_info lo on lo.id = re.user_id
			left join mman_loan_collection_order mo on mo.id = re.order_id
			left join back_user_company_permissions bp on re.user_id = bp.user_id
	</sql>
	<insert id="insert" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionRecord">INSERT INTO mman_loan_collection_record
		<trim prefix="(" suffix=")" suffixOverrides=","> 
			<if test="id != null">`id`,</if>  
			<if test="orderId != null">`order_id`,</if>  
			<if test="collectionId != null">`collection_id`,</if>  
			<if test="userId != null">`user_id`,</if>  
			<if test="contactType != null">`contact_type`,</if>  
			<if test="contactName != null">`contact_name`,</if>  
			<if test="relation != null">`relation`,</if>  
			<if test="contactPhone != null">`contact_phone`,</if>  
			<if test="stressLevel != null">`stress_level`,</if>  
			<if test="orderState != null">`order_state`,</if>  
			<if test="collectionType != null">`collection_type`,</if>  
			<if test="collectionDate != null">`collection_date`,</if>  
			<if test="collectionAmount != null">`collectionAmount`,</if>  
			<if test="content != null">`content`,</if>  
			<if test="createDate != null">`create_date`,</if>  
			<if test="updateDate != null">`update_date`,</if>  
			<if test="remark != null">`remark`,</if> 
		</trim>  
		<trim prefix="values (" suffix=")" suffixOverrides=","> 
			<if test="id != null">#{id,jdbcType=VARCHAR},</if>  
			<if test="orderId != null">#{orderId,jdbcType=VARCHAR},</if>  
			<if test="collectionId != null">#{collectionId,jdbcType=VARCHAR},</if>  
			<if test="userId != null">#{userId,jdbcType=VARCHAR},</if>  
			<if test="contactType != null">#{contactType,jdbcType=VARCHAR},</if>  
			<if test="contactName != null">#{contactName,jdbcType=VARCHAR},</if>  
			<if test="relation != null">#{relation,jdbcType=VARCHAR},</if>  
			<if test="contactPhone != null">#{contactPhone,jdbcType=VARCHAR},</if>  
			<if test="stressLevel != null">#{stressLevel,jdbcType=VARCHAR},</if>  
			<if test="orderState != null">#{orderState,jdbcType=VARCHAR},</if>  
			<if test="collectionType != null">#{collectionType,jdbcType=VARCHAR},</if>  
			<if test="collectionDate != null">#{collectionDate,jdbcType=TIMESTAMP},</if>  
			<if test="collectionAmount != null">#{collectionAmount,jdbcType=DECIMAL},</if>  
			<if test="content != null">#{content,jdbcType=VARCHAR},</if>  
			<if test="createDate != null">#{createDate,jdbcType=TIMESTAMP},</if>  
			<if test="updateDate != null">#{updateDate,jdbcType=TIMESTAMP},</if>  
			<if test="remark != null">#{remark,jdbcType=VARCHAR},</if> 
		</trim> 
	</insert>
	<!-- 更新不为NULL的字段 -->
	<update id="update" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionRecord">UPDATE mman_loan_collection_record
		<set> 
			<if test="orderId != null">order_id=#{orderId,jdbcType=VARCHAR},</if>  
			<if test="collectionId != null">collection_id=#{collectionId,jdbcType=VARCHAR},</if>  
			<if test="userId != null">user_id=#{userId,jdbcType=VARCHAR},</if>  
			<if test="contactType != null">contact_type=#{contactType,jdbcType=VARCHAR},</if>  
			<if test="contactName != null">contact_name=#{contactName,jdbcType=VARCHAR},</if>  
			<if test="relation != null">relation=#{relation,jdbcType=VARCHAR},</if>  
			<if test="contactPhone != null">contact_phone=#{contactPhone,jdbcType=VARCHAR},</if>  
			<if test="stressLevel != null">stress_level=#{stressLevel,jdbcType=VARCHAR},</if>  
			<if test="orderState != null">order_state=#{orderState,jdbcType=VARCHAR},</if>  
			<if test="collectionType != null">collection_type=#{collectionType,jdbcType=VARCHAR},</if>  
			<if test="collectionDate != null">collection_date=#{collectionDate,jdbcType=TIMESTAMP},</if>  
			<if test="collectionAmount != null">collectionAmount=#{collectionAmount,jdbcType=DECIMAL},</if>  
			<if test="content != null">content=#{content,jdbcType=VARCHAR},</if>  
			<if test="createDate != null">create_date=#{createDate,jdbcType=TIMESTAMP},</if>  
			<if test="updateDate != null">update_date=#{updateDate,jdbcType=TIMESTAMP},</if>  
			<if test="remark != null">remark=#{remark,jdbcType=VARCHAR},</if> 
		</set> WHERE id = #{id,jdbcType=VARCHAR}
	</update>
	<!-- 根据主键获取单条记录 -->
	<select id="get" resultMap="queryResultMap" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionRecord">SELECT t.id , t.order_id , t.collection_id , t.user_id , t.contact_type , t.contact_name , t.relation , t.contact_phone , t.stress_level , t.order_state , t.collection_type , t.collection_date , t.collectionAmount , t.content , t.create_date , t.update_date , t.remark FROM mman_loan_collection_record t WHERE id = #{id,jdbcType=VARCHAR}</select>
	<!-- 根据主键删除记录 -->
	<delete id="del" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionRecord">DELETE FROM mman_loan_collection_record WHERE id = #{id,jdbcType=VARCHAR}</delete>
	<!-- 根据orderid查询历史 -->
	<select id="findListRecord" resultMap="queryResultMap" parameterType="string">
		SELECT t.id,
       t.order_id,
       t.collection_id,
       mo.`loan_id` as user_id,
       t.contact_type,
       t.contact_name,
       t.relation,
       t.contact_phone,
       t.stress_level,
       t.order_state,
       t.collection_type,
       t.collection_date,
       t.collectionAmount,
       t.content,
       t.create_date,
       t.update_date,
       t.remark,
       c.`user_name` as collectionPerson
  FROM mman_loan_collection_record t
  left join mman_loan_collection_order mo on mo.id= t.order_id
  LEFT JOIN `back_user` c on t.`collection_id`= c.`uuid`
 WHERE t.order_id= #{orderId,jdbcType=VARCHAR}
 ORDER BY t.`create_date` DESC
	</select>
</mapper>
