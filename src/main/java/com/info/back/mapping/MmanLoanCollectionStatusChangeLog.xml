<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--      
	This file is automatically generated by autoCode(https://git.oschina.net/durcframework/autoCode)
-->
<mapper namespace="com.info.back.dao.IMmanLoanCollectionStatusChangeLogDao">
	<resultMap id="queryResultMap" type="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<!-- 催收订单ID -->
		<result column="loan_collection_order_id" property="loanCollectionOrderId" jdbcType="VARCHAR"/>
		<!-- 操作前状态 -->
		<result column="before_status" property="beforeStatus" jdbcType="VARCHAR"/>
		<!-- 操作后状态 -->
		<result column="after_status" property="afterStatus" jdbcType="VARCHAR"/>
		<!-- 操作类型(操作类型  1入催 2派单 3逾期等级转换 4转单 5委外 6取消委外 7委外成功 100催收完成 8月初分组 9回收(重置催收状态为待催收) 字典) -->
		<result column="type" property="type" jdbcType="VARCHAR"/>
		<!-- 创建时间 -->
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP"/>
		<!-- 操作人 -->
		<result column="operator_name" property="operatorName" jdbcType="VARCHAR"/>
		<!-- 操作备注 -->
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
		<!-- 催收公司ID -->
		<result column="company_id" property="companyId" jdbcType="VARCHAR"/>
		<!-- 当前催收员ID -->
		<result column="current_collection_user_id" property="currentCollectionUserId" jdbcType="VARCHAR"/>
		<!-- 当前订单等级 -->
		<result column="current_collection_Order_Level" property="currentCollectionOrderLevel" jdbcType="VARCHAR"/>
		<!-- 当前催收员组 -->
		<result column="current_collection_user_level" property="currentCollectionUserLevel" jdbcType="VARCHAR"/>
		<result column="loan_user_phone" property="loanTel" jdbcType="VARCHAR"/>
		<result column="loan_id" property="loanId" jdbcType="VARCHAR"/>
		<result column="repay_id" property="repayId" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="findAll" resultMap="queryResultMap" parameterType="HashMap">
		select
			ml.id,mo.loan_id as loanCollectionOrderId, mo.loan_user_phone loanTel, ml.before_status,ml.after_status,ml.type,ml.create_date,ml.operator_name,
			ml.remark<!-- ,mc.title as company_id -->,bu.user_name as currentCollectionUserId,ml.current_collection_user_level,
			ml.current_collection_Order_Level
		 from 
		<include refid="base_table"></include>
		<include refid="base_where"></include> 
		order by ml.create_date DESC
	</select>
	
	<select id="findAllCount" parameterType="HashMap" resultType="Integer">
		select count(1) 
		from 
		<include refid="base_table"></include>
		<include refid="base_where"></include>
	</select>
	
	<sql id="base_where">
		<where>
		<!-- 借款编号 -->
			<if test="loanCollectionOrderId != null and loanCollectionOrderId !=''">
				AND mo.loan_id = #{loanCollectionOrderId}
			</if>
		<!-- 催收员 -->
			<if test="collectionUser != null and collectionUser !=''">
				AND bu.user_name = #{collectionUser}
			</if>
			<!-- 借款手机号 -->
			<if test="loanTel != null and loanTel !=''">
				AND mo.loan_user_phone = #{loanTel}
			</if>
		<!-- 操作类型 -->
			<if test="type != null and type != ''">
				AND ml.type = #{type}
			</if>
		<!-- 操作员 -->
			<if test="operatorName != null and operatorName != ''">
				AND ml.operator_name = #{operatorName}
			</if>
		<!-- 催收员只能查看自己的记录 -->
			<if test="userRoleId != null and userRoleId != ''">
				AND ml.current_collection_user_id = #{userRoleId}
			</if>
		<!-- 委外经理能查看自己公司的记录 -->
			<!-- <if test="outSourceCompanyId != null and outSourceCompanyId != ''">
				AND mc.id = outSourceCompanyId
			</if> -->
			
			<if test="CompanyPermissionsList != null and CompanyPermissionsList.size>0 " >
				AND bu.`company_id` in  
					<foreach collection="CompanyPermissionsList" close=")" item="items" open="(" separator=",">
						#{items.companyId} 
					</foreach>
			</if>
			<!-- 按流转日志的创建时间查询流转日志记录 -->
			<if test="beginTime != null and beginTime != ''">
				AND DATE_FORMAT(ml.create_date,"%Y-%m-%d") &gt;= #{beginTime} 
			</if>
			<if test="endTime != null and endTime != ''">
				AND DATE_FORMAT(ml.create_date,"%Y-%m-%d") &lt;= #{endTime} 
			</if>
			<if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
				AND DATE_FORMAT(ml.create_date,"%Y-%m-%d") &gt;= #{beginTime} AND DATE_FORMAT(ml.create_date,"%Y-%m-%d") &lt;= #{endTime}
			</if>
		<!-- 催收主管或者是经理可以查看全部记录 -->
			<!-- <if test="noAdmin != null and noAdmin != ''">
				AND 1 = 1
			</if> -->
		</where>
	</sql>
	
	<sql id="base_table">
			mman_loan_collection_status_change_log ml
		 	left join mman_loan_collection_company mc on ml.company_id = mc.id
		 	left join back_user bu on bu.uuid = ml.current_collection_user_id
		 	left join mman_loan_collection_order mo on mo.order_id = ml.loan_collection_order_id
	</sql>
	<!-- 保存,保存不为NULL的字段 -->
	<insert id="saveNotNull" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">INSERT INTO mman_loan_collection_status_change_log
		<trim prefix="(" suffix=")" suffixOverrides=","> 
			<if test="id != null">`id`,</if>  
			<if test="loanCollectionOrderId != null">`loan_collection_order_id`,</if>  
			<if test="beforeStatus != null">`before_status`,</if>  
			<if test="afterStatus != null">`after_status`,</if>  
			<if test="type != null">`type`,</if>  
			<if test="createDate != null">`create_date`,</if>  
			<if test="operatorName != null">`operator_name`,</if>  
			<if test="remark != null">`remark`,</if>  
			<if test="companyId != null">`company_id`,</if> 
		</trim>  
		<trim prefix="values (" suffix=")" suffixOverrides=","> 
			<if test="id != null">#{id,jdbcType=VARCHAR},</if>  
			<if test="loanCollectionOrderId != null">#{loanCollectionOrderId,jdbcType=VARCHAR},</if>  
			<if test="beforeStatus != null">#{beforeStatus,jdbcType=VARCHAR},</if>  
			<if test="afterStatus != null">#{afterStatus,jdbcType=VARCHAR},</if>  
			<if test="type != null">#{type,jdbcType=VARCHAR},</if>  
			<if test="createDate != null">#{createDate,jdbcType=TIMESTAMP},</if>  
			<if test="operatorName != null">#{operatorName,jdbcType=VARCHAR},</if>  
			<if test="remark != null">#{remark,jdbcType=VARCHAR},</if>  
			<if test="companyId != null">#{companyId,jdbcType=VARCHAR},</if> 
		</trim> 
	</insert>
	<!-- 更新不为NULL的字段 -->
	<update id="updateNotNull" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">UPDATE mman_loan_collection_status_change_log
		<set> 
			<if test="loanCollectionOrderId != null">loan_collection_order_id=#{loanCollectionOrderId,jdbcType=VARCHAR},</if>  
			<if test="beforeStatus != null">before_status=#{beforeStatus,jdbcType=VARCHAR},</if>  
			<if test="afterStatus != null">after_status=#{afterStatus,jdbcType=VARCHAR},</if>  
			<if test="type != null">type=#{type,jdbcType=VARCHAR},</if>  
			<if test="createDate != null">create_date=#{createDate,jdbcType=TIMESTAMP},</if>  
			<if test="operatorName != null">operator_name=#{operatorName,jdbcType=VARCHAR},</if>  
			<if test="remark != null">remark=#{remark,jdbcType=VARCHAR},</if>  
			<if test="companyId != null">company_id=#{companyId,jdbcType=VARCHAR},</if> 
		</set> WHERE id = #{id,jdbcType=VARCHAR}
	</update>
	<!-- 根据主键获取单条记录 -->
	<select id="get" resultMap="queryResultMap" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">SELECT t.id , t.loan_collection_order_id , t.before_status , t.after_status , t.type , t.create_date , t.operator_name , t.remark , t.company_id FROM mman_loan_collection_status_change_log t WHERE id = #{id,jdbcType=VARCHAR}</select>
	<!-- 根据主键删除记录 -->
	<delete id="del" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">DELETE FROM mman_loan_collection_status_change_log WHERE id = #{id,jdbcType=VARCHAR}</delete>
	
	
	
		
	<!-- 保存,保存不为NULL的字段 -->
	<insert id="insert" parameterType="com.info.web.pojo.cspojo.MmanLoanCollectionStatusChangeLog">
	INSERT INTO mman_loan_collection_status_change_log 
		<trim prefix="(" suffix=")" suffixOverrides=","> 
			<if test="id != null">id,</if>  
			<if test="loanCollectionOrderId != null and loanCollectionOrderId!=''">loan_collection_order_id,</if>  
			<if test="beforeStatus != null and beforeStatus !=''">before_status,</if>  
			<if test="afterStatus != null and afterStatus!=''">after_status,</if>  
			<if test="type != null and type!=''">type,</if>  
			<if test="createDate != null">create_date,</if>  
			<if test="operatorName != null and operatorName!=''">operator_name,</if>  
			<if test="remark != null and remark!=''">remark,</if>  
			<if test="companyId != null and companyId!=''">company_id,</if> 
			<if test="currentCollectionUserId != null and currentCollectionUserId!=''">current_collection_user_id,</if> 
			<if test="currentCollectionUserLevel != null and currentCollectionUserLevel!=''">current_collection_user_level,</if> 
			<if test="currentCollectionOrderLevel != null and currentCollectionOrderLevel!=''">current_collection_Order_Level,</if> 
		</trim>  
		<trim prefix="values (" suffix=")" suffixOverrides=","> 
			<if test="id != null">#{id},</if>  
			<if test="loanCollectionOrderId != null and loanCollectionOrderId!=''">#{loanCollectionOrderId},</if>  
			<if test="beforeStatus != null and beforeStatus !=''">#{beforeStatus},</if>  
			<if test="afterStatus != null and afterStatus!=''">#{afterStatus},</if>  
			<if test="type != null and type!=''">#{type},</if>  
			<if test="createDate != null">#{createDate},</if>  
			<if test="operatorName != null and operatorName!=''">#{operatorName},</if>  
			<if test="remark != null and remark!=''">#{remark},</if>  
			<if test="companyId != null and companyId!=''">#{companyId},</if> 
			<if test="currentCollectionUserId != null and currentCollectionUserId!=''">#{currentCollectionUserId},</if> 
			<if test="currentCollectionUserLevel != null and currentCollectionUserLevel!=''">#{currentCollectionUserLevel},</if> 
			<if test="currentCollectionOrderLevel != null and currentCollectionOrderLevel!=''">#{currentCollectionOrderLevel},</if> 
		</trim> 
	</insert>
	
	<!-- 根据orderid查询log -->
	<select id="findListLog" resultMap="queryResultMap" parameterType="string">
		SELECT t.id , t.loan_collection_order_id , t.before_status , t.after_status , t.type , t.create_date , t.operator_name , t.remark ,
		u.user_name as current_collection_user_id,t.current_collection_user_level,t.current_collection_Order_Level
		FROM mman_loan_collection_status_change_log t 
		left join back_user u on t.current_collection_user_id=u.uuid
		WHERE loan_collection_order_id = #{orderId,jdbcType=VARCHAR}
		order by t.create_date desc
	</select>
	
	
	<select id="findSystemUpToS2Log" resultType="Integer" parameterType="HashMap">
		SELECT COUNT(1) FROM mman_loan_collection_status_change_log t WHERE t.`type`='2' 
		AND t.`current_collection_user_level`='4' 
		AND t.`loan_collection_order_id`=#{collectionOrderId};
	</select>
	
	<select id="findOrderSingle" resultType="Integer" parameterType="HashMap">
		SELECT COUNT(1) FROM mman_loan_collection_status_change_log l WHERE l.`current_collection_user_id`=#{currentCollectionUserId} AND l.`loan_collection_order_id`=#{orderId} AND l.`type`='3' 
	</select>

	<select id="getOrderIdNum" resultType="Integer">
		SELECT count(DISTINCT(loan_collection_order_id)) FROM `mman_loan_collection_status_change_log`
		WHERE `operator_name` = '系统' and date(`create_date`) &gt;= '2018-01-01'
		and type in (1,2) and loan_collection_order_id != 0
	</select>

	<select id="getOrderIds" resultType="String" parameterType="HashMap">
		select DISTINCT(loan_collection_order_id) from `mman_loan_collection_status_change_log` limit #{offSet},#{pageSize}
	</select>
	
	<select id="getLogByOrderIds" resultMap="queryResultMap" parameterType="java.util.List">
		SELECT mo.loan_id, p.id repay_id, t.create_date,t.current_collection_user_level
		FROM mman_loan_collection_status_change_log t
		left join mman_loan_collection_order mo on mo.order_id = t.loan_collection_order_id
		left join credit_loan_pay p on mo.loan_id = p.loan_id
		WHERE t.loan_collection_order_id in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
</mapper>
